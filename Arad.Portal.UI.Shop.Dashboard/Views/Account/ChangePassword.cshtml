@using System.Globalization
@model Arad.Portal.DataLayer.Models.User.RegisterDTO
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles{
    <style>
        input::placeholder {
            text-align: center;
        }

        input {
            border-color: #9e9e9e !important;
        }

        #imgcpatcha::placeholder {
            font-size: 12px;
            text-align: center;
        }

        .iti__selected-flag {
            direction: ltr;
        }

        body {
            align-content: center;
            background-color: white !important;
            display: flex;
            font-family: @(CultureInfo.CurrentCulture.Name == "fa-IR" ? "IRANSansWeb" : null);
            font-size: 14px;
            justify-content: center;
            padding-top: 80px;
        }

        .loginSignUpSeparator {
            border-top: 1px solid #cbd2d6;
            margin: 25px 0 10px;
            position: relative;
            text-align: center;
        }

            .loginSignUpSeparator .textInSeparator {
                background-color: #fff;
                color: #6c7378;
                padding: 0 .5em;
                position: relative;
                top: -.7em;
            }
    </style>
    <link href="@Url.Content($"~/lib/intl-tel-input/css/intlTelInput.css")" rel="stylesheet" />

}
    <div style="width: 400px;">
        <div class="card card-outline">

            <div class="card-body">

                <form id="resetPassword"
                  role="form"
                  method="post"
                  asp-controller="Account"
                  asp-action="ChangePassword">

                    <div class="input-group mb-3">
                        <input type="text" class="form-control"
                           asp-for="Username" placeholder="@Language.GetString("TextAndPlaceholder_UserName")" aria-label="Username" aria-describedby="userNameIcon">
                        <span class="input-group-text" id="userNameIcon">
                            <span class="fas fa-user"
                              @*style="width: 16px;"*@>
                            </span>
                        </span>

                    </div>
                    <div style="text-align: center">
                        <span data-val-result="Username"
                          class="text-danger">
                        </span>
                    </div>

                    <div class="input-group mb-3" @*style="margin-bottom: 12px !important;"*@>
                        <input type="tel" class="form-control"
                           asp-for="CellPhoneNumber" placeholder="@Language.GetString("TextAndPlaceholder_Mobile")" aria-label="CellPhoneNumber" aria-describedby="MobileIcon">
                        <span class="input-group-text" id="MobileIcon">
                            <span class="fas fa-mobile-alt"
                              @*style="width: 16px;"*@>
                            </span>
                        </span>

                    </div>

                    <div style="text-align: center">
                        <span data-val-result="CellPhoneNumber"
                          class="text-danger">
                        </span>
                    </div>

                    <div class="input-group mb-3" @*style="margin-bottom: 12px !important;"*@>
                        <input type="password" class="form-control"
                           asp-for="NewPass" placeholder="@Language.GetString("AlertAndMessage_Password")" aria-label="NewPass" aria-describedby="PassIcon">
                        <span class="input-group-text" id="PassIcon">
                            <span class="fas fa-lock"
                              @*style="width: 16px;"*@>
                            </span>
                        </span>
                        <button class="btn btn-outline-secondary" onclick="togglePassword()" type="button">
                            <i class="fas fa-eye-slash" id="ic_span"> </i>
                        </button>
                    </div>

                    <div class="input-group mb-3" @*style="margin-bottom: 12px !important;"*@>
                        <input type="password" class="form-control"
                           asp-for="ReNewPass" placeholder="@Language.GetString("User_RePassword")" aria-label="ReNewPass" aria-describedby="PassIcon2">
                        <span class="input-group-text" id="PassIcon2">
                            <span class="fas fa-lock"
                              @*style="width: 16px;"*@>
                            </span>
                        </span>

                    </div>

                    <div class="row">
                        <button type="submit"
                            class="btn btn-primary bg-gradient"
                            disabled="disabled"
                            id="btnSubmit">
                            @Language.GetString("btn_ChangePass")
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@section Scripts
{
    <script src="@Url.Content($"~/lib/intl-tel-input/js/intlTelInput-jquery.min.js")"></script>
    <script src="@Url.Content($"~/lib/intl-tel-input/js/intlTelInput.js")"></script>

    <script>
        var cell = document.querySelector("#CellPhoneNumber");
        var cellPhoneInit = window.intlTelInput(cell,
            {
                initialCountry: "IR",
                placeholderNumberType: "MOBILE",
                separateDialCode: true,
                nationalMode: true,
                hiddenInput: "FullCellPhoneNumber"
            });


        $(document).ready(function () {


            $("#resetPassword")
                .submit(function (e) {
                    debugger;
                    e.preventDefault();
                    const myForm = document.getElementById('resetPassword');
                    var form = new FormData(myForm);
                    form.append("UserName", $("#Username").val());
                    $("#btnSubmit").prop('disabled', true);

                    $.ajax({
                        url: $(this).attr('action'),
                        data: form,
                        type: 'Post',
                        processData: false,
                        contentType: false,
                        beforeSend: function () {
                            $("#loading").addClass('is-active');
                        },
                        statusCode: {
                            200: function (result) {
                                $("#loading").removeClass('is-active');
                                if (result.status === "Success") {
                                    $('#mainToastBody').html(`<i class="far fa-check-circle"></i> ${result.message}`);
                                    $('#mainToastBody').addClass('alert-success');
                                    $("#toastPanel").show();
                                    var toast = new bootstrap.Toast($("#mainToast"));
                                    toast.show();
                                    setTimeout(function () {
                                        $("#toastPanel").hide();
                                        window.location.href = '@Url.Action("Login", "Account")';
                                    }, 2500);
                                }
                                if (result.status === "ModelError") {
                                    const spanErrorList = $('span[data-val-result]');
                                    if (spanErrorList.length > 1) {
                                        spanErrorList.each(function () {
                                            $(this).html("");
                                            $(this).parent().removeClass("has-error");
                                        });
                                    }
                                    else {
                                        spanErrorList.html("");
                                        spanErrorList.parent().removeClass("has-error");
                                    }

                                    if (result.modelStateErrors !== null) {
                                        result.modelStateErrors.forEach(function (value, index) {
                                            $(`[data-val-result=${value.key}]`).html(value.errorMessage);
                                            $(`[data-val-result=${value.key}]`).parent().addClass("has-error");
                                        });
                                    }
                                    $("#btnSubmit").prop('disabled', false);
                                }
                                if (result.status === "Error") {


                                    document.getElementById('mainToastBody').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${result.message}`;
                                    document.getElementById('mainToastBody').classList.add('alert-danger');
                                    var toastDiv = $("#mainToast");
                                    $("#toastPanel").show();
                                    var toast = new bootstrap.Toast(toastDiv);
                                    toast.show();

                                    setTimeout(function () {
                                        $("#toastPanel").hide();
                                    }, 1500);

                                    $("#btnSubmit").prop('disabled', false);
                                }
                            },
                            401: function () {
                                $("#loading").removeClass('is-active');
                                window.location.href = '@Url.Action("Login")';
                            }
                        }
                    });
                });
        });

        window.addEventListener("beforeunload",
            function () {
                $("#loading").addClass('is-active');
            });


        function refreshCaptcha() {
            $("#imgcpatcha").attr('src', `@Url.Action("CaptchaImage", "Captcha")?${new Date().getTime()}`);
            $("#inlineFormInputGroup").val('');
            $("#inlineFormInputGroup").focus();
            $('#captValidation').empty();
        }

    </script>
}